---
description: 项目技术信息 - 模型架构、数据集、训练配置等详细技术信息
alwaysApply: false
---

# 项目技术信息

本文档包含论文项目的详细技术信息，用于指导 AI 生成准确的技术描述。

## 项目概述

### 项目类型
基于 MMSegmentation 框架的语义分割项目，用于二分类分割任务（背景和目标）。

### 核心模型
改进的 DeepLabV3+ 模型，添加了双重注意力机制：
- **TR模块**（Transformer Routing）：全局上下文注意力模块
- **SAE模块**（Spatial Attention Enhancement）：局部细节增强模块

### 应用场景
- 主要应用：OCT图像语义分割（用于激光焊接熔池检测）
- 也可应用于：裂缝检测、医学图像分割等需要精确边界定位的场景

## 模型架构

### 整体架构

基于 DeepLabV3+ 的编码器-解码器结构：

```
输入图像 (512×512×3)
    ↓
┌─────────────────────────────┐
│ 编码器 (Encoder)             │
│ ResNet18-V1c 骨干网络        │
│ - Stage 1: 256×256×64        │
│ - Stage 2: 128×128×128       │
│ - Stage 3: 64×64×256         │
│ - Stage 4: 32×32×512         │
└─────────────────────────────┘
    ↓ [取 Stage 4 特征]
32×32×512
    ↓
┌─────────────────────────────┐
│ ASPP模块                     │
│ 5个并行分支：                │
│ - 1×1卷积: 32×32×512         │
│ - dilation=12: 32×32×512     │
│ - dilation=24: 32×32×512     │
│ - dilation=36: 32×32×512     │
│ - 全局池化: 32×32×512        │
│ 拼接: 32×32×2560             │
└─────────────────────────────┘
    ↓
32×32×2560
    ↓
┌─────────────────────────────┐
│ TR模块 (BiformerBlock)       │
│ 双层路由注意力机制           │
│ 输入: 32×32×2560             │
│ 输出: 32×32×2560             │
└─────────────────────────────┘
    ↓
32×32×2560
    ↓ [1×1卷积降维]
32×32×512
    ↓ [上采样×2]
64×64×512
    ↓ [与Stage 1特征融合]
┌─────────────────────────────┐
│ 解码器 (Decoder)             │
│ Stage 1特征: 256×256×64      │
│ 降维: 64×64×48               │
│ 拼接: 64×64×560              │
└─────────────────────────────┘
    ↓
64×64×560
    ↓
┌─────────────────────────────┐
│ SAE模块 (CoordSaeLayer)      │
│ 坐标注意力 + 通道注意力       │
│ 输入: 64×64×560              │
│ 输出: 64×64×560              │
└─────────────────────────────┘
    ↓
64×64×560
    ↓ [深度可分离卷积]
64×64×512
    ↓ [分类头]
64×64×2
    ↓ [上采样×8]
512×512×2
```

### 骨干网络：ResNet18-V1c

**配置参数**：
- **类型**: ResNetV1c
- **深度**: 18层
- **预训练权重**: `open-mmlab://resnet18_v1c`
- **输出特征层**: 4个阶段 (out_indices=(0, 1, 2, 3))
- **Deep Stem结构**: 使用三个连续的3×3卷积替换传统的7×7卷积

**特征图尺寸变化**：
- **输入**: 512×512×3
- **Stage 1输出**: 256×256×64 (stride=2)
- **Stage 2输出**: 128×128×128 (stride=2)
- **Stage 3输出**: 64×64×256 (stride=2)
- **Stage 4输出**: 32×32×512 (stride=2) ← 用于ASPP

**关键设计**：
- 使用 `contract_dilation=True` 避免网格伪影
- `norm_eval=False` 允许训练时更新BN参数

### ASPP模块

**配置参数**：
- **类型**: DepthwiseSeparableASPPModule
- **输入通道**: 512
- **输出通道**: 512（每个分支）
- **空洞率**: (1, 12, 24, 36)
- **并行分支数**: 5个（包括全局平均池化）

**5个并行分支**：
1. **1×1卷积**: 标准卷积，感受野1×1，捕获细节特征
2. **3×3空洞卷积 (dilation=12)**: 感受野约25×25，捕获局部特征
3. **3×3空洞卷积 (dilation=24)**: 感受野约49×49，捕获区域特征
4. **3×3空洞卷积 (dilation=36)**: 感受野约73×73，捕获全局特征
5. **全局平均池化**: 感受野为整个特征图，捕获全局上下文

**输出特征**：
- 5个分支拼接：32×32×2560 (512×5)
- 通过1×1卷积降维：32×32×512

**深度可分离卷积**：
- 使用深度可分离卷积降低计算复杂度
- 先进行深度卷积（逐通道），再进行点卷积（1×1）

### TR模块（Transformer Routing）

**模块名称**: BiformerBlock

**核心机制**: 双层路由注意力（Bi-Level Routing Attention）

**输入输出**：
- **输入**: 32×32×2560（ASPP输出）
- **输出**: 32×32×2560（注意力增强后的特征）

**窗口划分**：
- **特征图尺寸**: 32×32
- **窗口大小**: 4×4
- **窗口数量**: (32/4) × (32/4) = 8×8 = **64个窗口**

**TopK路由机制**：
- **TopK值**: k=4（每个窗口选择4个最相关的窗口）
- **路由计算**: 计算窗口间的相似度，选择Top-4窗口
- **计算复杂度**: 从O(n²)降低至O(n²×k/p²)，约减少75%计算量

**注意力计算**：
1. **区域级路由**: 计算窗口间的相似度
   - 对每个窗口的所有令牌求平均，得到区域级查询Q_region和键K_region
   - 计算Q_region × K_region^T，得到64×64的窗口间相似度矩阵
2. **TopK选择**: 每个窗口选择4个最相关的窗口
3. **令牌级注意力**: 在选定的窗口内进行像素级注意力计算

**结构组成**：
- **位置编码**: 使用深度可分离卷积（3×3，groups=dim）
- **LayerNorm**: 归一化处理
- **双层路由注意力**: BiLevelRoutingAttention
- **MLP**: 多层感知机（扩展-压缩结构）
- **残差连接**: 两个残差连接（注意力后和MLP后）

**关键公式**：
```
标准自注意力: Attention(Q, K, V) = softmax(QK^T / √d_k) × V

区域级路由相似度: S_ij = (Q_region^(i) · K_region^(j)) / (||Q_region^(i)|| × ||K_region^(j)||)

TopK路由: TopK_Indices = TopK(Routing_Score, k=4)
稀疏注意力: Attention_Sparse = Attention(Q[TopK_Indices], K[TopK_Indices], V[TopK_Indices])
```

**作用**：
- 捕获全局上下文信息
- 理解整个特征图的空间关系
- 降低计算复杂度，提高效率

### SAE模块（Spatial Attention Enhancement）

**模块名称**: CoordSaeLayer

**核心机制**: 坐标注意力 + 通道注意力（Squeeze-and-Excitation）

**输入输出**：
- **输入**: 64×64×560（Decoder融合后的特征）
- **输出**: 64×64×560（增强后的特征）

**结构组成**：

1. **坐标注意力（CoordAtt）**：
   - **H方向池化**: 对每个高度位置h，在宽度维度W上求平均
     - 输出维度: [H, 1, C]
   - **W方向池化**: 对每个宽度位置w，在高度维度H上求平均
     - 输出维度: [1, W, C]
   - **特征拼接**: Concat(x_h, x_w) → [H+W, 1, C]
   - **1×1卷积**: 降维到 [H+W, 1, C/reduction]，reduction=4
   - **分离卷积**: 分别生成H和W方向的注意力权重
   - **应用权重**: output = x × a_h × a_w

2. **卷积处理**：
   - 两个连续的3×3卷积
   - BatchNorm + ReLU激活
   - 残差连接

3. **通道注意力（SaELayer）**：
   - **全局平均池化**: 64×64×560 → 560
   - **4分支处理**: 
     - 4个全连接层分支，每个分支输出140维
     - 拼接后得到560维
   - **全连接层**: 生成通道注意力权重
   - **应用权重**: output = x × channel_attention

**关键公式**：
```
坐标注意力H方向: x_h[h, c] = (1/W) × Σ x[h, w, c]
坐标注意力W方向: x_w[w, c] = (1/H) × Σ x[h, w, c]
坐标注意力权重: y = Concat(x_h, x_w), z = Conv1×1(y), a_h = Sigmoid(Conv_h(z)), a_w = Sigmoid(Conv_w(z))
最终输出: F_enhanced = F × a_h × a_w × A_channel
```

**作用**：
- 增强空间位置信息（坐标注意力）
- 增强重要通道（通道注意力）
- 提高边界分割精度

### 解码器

**特征融合**：
- **高层特征**: 32×32×512（ASPP+TR输出，上采样到64×64）
- **低层特征**: 256×256×64（Stage 1输出）
  - 通过1×1卷积降维: 64×64×48
- **融合方式**: 通道维度拼接
- **融合后**: 64×64×560 (512+48)

**上采样**：
- 使用双线性插值（bilinear interpolation）
- align_corners=False

### 分类头

**结构**：
- **深度可分离卷积**: 两个连续的深度可分离卷积模块
- **1×1卷积**: 输出类别logits
- **最终上采样**: 64×64×2 → 512×512×2

**输出**：
- 每个像素的类别概率
- 2个类别：背景和目标

## 损失函数

### 组合损失函数

采用二元交叉熵损失和Dice损失的加权组合：

```
L_total = λ₁ × L_BCE + λ₂ × L_Dice
```

其中：
- **λ₁ = 2.0**（BCE损失权重）
- **λ₂ = 2.0**（Dice损失权重）

### BCE损失（带Sigmoid）

```
L_BCE = -(1/N) × Σ [y_i × log(σ(p_i)) + (1-y_i) × log(1-σ(p_i))]
```

其中：
- y_i: 真实标签（0或1）
- p_i: 预测logits
- σ(p_i): Sigmoid激活后的概率

### Dice损失

```
L_Dice = 1 - (2 × Σ(p_i × y_i) + ε) / (Σp_i + Σy_i + ε)
```

其中：
- ε: 平滑项（防止除零），通常为1e-5
- 用于处理类别不平衡问题

**优势**：
- BCE损失：提供逐像素的梯度信号
- Dice损失：关注区域重叠，对类别不平衡更鲁棒
- 组合使用：兼顾像素级精度和区域级一致性

## 数据集

### 数据集概况

- **训练集**: 912张图像
- **测试集**: 228张图像
- **图像尺寸**: 512×512像素
- **类别数**: 2（背景和目标）
- **数据格式**: RGB图像 + 单通道标签图

### 数据增强策略

训练时采用以下数据增强：

1. **Resize**: 调整图像尺寸到512×512
2. **RandomFlip**: 随机翻转（flip_ratio=0，实际未启用）
3. **PhotoMetricDistortion**: 光度失真
   - 亮度调整
   - 对比度调整
   - 饱和度调整
   - 色调调整
4. **Normalize**: 标准化处理
   - mean=[0, 0, 0]
   - std=[1, 1, 1]
5. **Pad**: 填充处理
   - pad_val=0（图像填充值）
   - seg_pad_val=255（标签填充值）

**数据重复**：
- 使用RepeatDataset，times=1000
- 有效训练样本数：912 × 1000 = 912,000

## 训练配置

### 优化器

- **类型**: Adam
- **学习率**: 1e-6
- **Beta参数**: (0.9, 0.999)
- **权重衰减**: 5e-3

### 学习率调度

- **策略**: 多项式衰减（poly）
- **衰减指数**: 0.9
- **最小学习率**: 1e-6
- **按迭代数调度**: by_epoch=False

**公式**：
```
lr = base_lr × (1 - iter/max_iter)^power
```

### 训练参数

- **迭代次数**: 20,000次
- **批次大小**: 8（每个GPU）
- **工作进程数**: 4（每个GPU）
- **评估间隔**: 每500次迭代
- **检查点保存**: 每10,000次迭代
- **评估指标**: mIoU, mFscore, mDice

### 训练流程

1. **数据加载**: 从datasets目录加载图像和标签
2. **数据增强**: 应用训练pipeline中的增强操作
3. **前向传播**: 通过网络得到预测结果
4. **损失计算**: 计算组合损失
5. **反向传播**: 更新模型参数
6. **评估**: 每500次迭代评估一次性能

## 创新点

### 1. 双重注意力机制

**TR模块（全局注意力）**：
- 解决全局上下文信息捕获不足的问题
- 通过双层路由注意力机制，理解整个特征图的空间关系
- 使用TopK路由降低计算复杂度

**SAE模块（局部注意力）**：
- 解决局部细节信息丢失的问题
- 通过坐标注意力和通道注意力，增强重要空间位置和通道
- 提高边界分割精度

**协同效应**：
- TR模块负责全局上下文建模
- SAE模块负责局部细节增强
- 两者互补，性能提升超过单独使用任一模块

### 2. 高效计算设计

**深度可分离卷积**：
- ASPP模块使用深度可分离卷积
- 降低参数量和计算量

**TopK路由机制**：
- TR模块只关注Top-4最相关的窗口
- 计算复杂度从O(n²)降低至O(n²×k/p²)
- 约减少75%的计算量

### 3. 组合损失函数

**BCE + Dice损失**：
- BCE损失提供逐像素梯度
- Dice损失关注区域重叠
- 有效处理类别不平衡问题

## 技术细节

### 特征图尺寸变化

| 阶段 | 操作 | 输入尺寸 | 输出尺寸 | 说明 |
|------|------|----------|----------|------|
| 输入 | 原始图像 | 512×512×3 | - | RGB图像 |
| ResNet Stage1 | 卷积+下采样 | 512×512×3 | 256×256×64 | stride=2 |
| ResNet Stage2 | 卷积+下采样 | 256×256×64 | 128×128×128 | stride=2 |
| ResNet Stage3 | 卷积+下采样 | 128×128×128 | 64×64×256 | stride=2 |
| ResNet Stage4 | 卷积+下采样 | 64×64×256 | 32×32×512 | stride=2 |
| ASPP拼接 | 多分支拼接 | 5×32×32×512 | 32×32×2560 | 5个分支 |
| TR模块 | 注意力增强 | 32×32×2560 | 32×32×2560 | 全局上下文 |
| Bottleneck | 1×1卷积 | 32×32×2560 | 32×32×512 | 降维 |
| 上采样 | 双线性插值 | 32×32×512 | 64×64×512 | ×2上采样 |
| c1_bottleneck | 1×1卷积 | 256×256×64 | 64×64×48 | 下采样+降维 |
| 特征拼接 | torch.cat | 64×64×(512+48) | 64×64×560 | 融合高低层 |
| SAE模块 | 特征增强 | 64×64×560 | 64×64×560 | 局部增强 |
| Sep Bottleneck | 深度可分离卷积 | 64×64×560 | 64×64×512 | 降维+融合 |
| 分类头 | 1×1卷积 | 64×64×512 | 64×64×2 | 类别logits |
| 最终上采样 | 双线性插值 | 64×64×2 | 512×512×2 | ×8上采样 |

### 关键参数

**ASPP模块**：
- dilations = (1, 12, 24, 36)
- channels = 512
- dropout_ratio = 0.1

**TR模块**：
- 输入维度 = 2560
- 窗口大小 = 4×4
- TopK = 4
- 窗口数量 = 64 (8×8)

**SAE模块**：
- 输入输出维度 = 560
- 坐标注意力reduction = 4
- 通道注意力分支数 = 4

**解码器**：
- c1_in_channels = 64
- c1_channels = 48

## 专利交底书审核发现

### 需要修正的技术描述

1. **特征图尺寸错误**：
   - ❌ 专利中描述：ASPP输出16×16×2560，TR模块处理16×16特征图得到16个窗口
   - ✅ 实际代码：ASPP输出32×32×2560，TR模块处理32×32特征图得到64个窗口（8×8）

2. **窗口数量错误**：
   - ❌ 专利中描述：16×16特征图分割为4×4窗口得到16个窗口
   - ✅ 实际代码：32×32特征图分割为4×4窗口得到64个窗口

3. **Stage 4输出尺寸**：
   - ❌ 专利中描述：第四阶段输出16×16×512
   - ✅ 实际代码：第四阶段输出32×32×512

**注意**：在论文写作时，应使用正确的技术描述（32×32特征图，64个窗口）。

## 代码位置

- **模型定义**: `mmseg/models/decode_heads/sep_aspp_head.py`
- **配置文件**: `my_config/deeplabv3plus_all.py`
- **TR模块实现**: `mmseg/models/decode_heads/sep_aspp_head.py` (BiformerBlock类)
- **SAE模块实现**: `mmseg/models/decode_heads/sep_aspp_head.py` (CoordSaeLayer类)
